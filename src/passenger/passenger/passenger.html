<div class="container-fluid mb-0 p-0">
  <form autocomplete="off" id="deliveryForm" class="w-100">
    <h2 class="text-center my-4 fw-bold text-primary">
      {{ op_id() }}
    </h2>
    <input type="hidden" id="operationId" name="operationId" />

    <div class="card shadow-sm border-0 mb-2 border-start border-primary border-4">
      <div class="card-header border-0 py-1 bg-primary d-flex align-items-center justify-content-between">
        <h6 class="mb-0 text-light fw-bold" style="font-size: 0.8rem;">
          <i class="bi bi-person-up me-1"></i>EXPÉDITEUR
        </h6>
        <button type="button" class="btn btn-xs btn-outline-light border-0 py-0" (click)="resetSender()" style="font-size: 0.7rem;">Réinitialiser</button>
      </div>
      <div class="card-body py-2">
        <div class="row g-1">
          <div class="col-md-2 position-relative">
            <label for="senderTel">Téléphone</label>
            <input id="senderTel" name="sendTel" type="tel" class="form-control form-control-sm" placeholder="Téléphone"
              [(ngModel)]="currentSender.sendTel" (input)="cheksender($event)">
            
            <div class="suggestion-box shadow border" *ngIf="filteredSenders.length > 0 && activeField === 'tel'">
              <div class="suggestion-item p-2 border-bottom" *ngFor="let s of filteredSenders" (click)="selectSender(s)">
                <small><strong>{{ s.sendTel }}</strong> - {{ s.sendName }}</small>
              </div>
            </div>
          </div>

          <div class="col-md-3 position-relative">
            <label for="senderName">Nom Complet</label>
            <input id="senderName" name="sendName" type="text" class="form-control form-control-sm" placeholder="Nom Complet"
              [(ngModel)]="currentSender.sendName" (input)="cheksender($event)">

            <div class="suggestion-box shadow border" *ngIf="filteredSenders.length > 0 && activeField === 'name'">
              <div class="suggestion-item p-2 border-bottom" *ngFor="let s of filteredSenders" (click)="selectSender(s)">
                <small><strong>{{ s.sendName }}</strong> ({{ s.sendTel }})</small>
              </div>
            </div>
          </div>

          <div class="col-md-3 position-relative">
            <label for="sendSocialReason">Raison Sociale</label>
            <input id="sendSocialReason" name="sendSocialReason" type="text" class="form-control form-control-sm" placeholder="Raison Sociale"
              [(ngModel)]="currentSender.sendSocialReason" (input)="cheksender($event)">

            <div class="suggestion-box shadow border" *ngIf="filteredSenders.length > 0 && activeField === 'social'">
              <div class="suggestion-item p-2 border-bottom" *ngFor="let s of filteredSenders" (click)="selectSender(s)">
                <small><strong>{{ s.sendSocialReason }}</strong> - {{ s.sendName }}</small>
              </div>
            </div>
          </div>

          <div class="col-md-4"><label for="senderAdress">Adresse</label><input id="senderAdress" name="adress" type="text" class="form-control form-control-sm" placeholder="Adresse" [(ngModel)]="currentSender.adress"></div>
          <div class="col-md-2"><label for="senderVille">Ville</label><input id="senderVille" name="city" type="text" class="form-control form-control-sm" placeholder="Ville" [(ngModel)]="currentSender.city"></div>
          <div class="col-md-2"><label for="senderPostal">Code Postal</label><input id="senderPostal" name="postalCode" type="text" class="form-control form-control-sm" placeholder="CP" [(ngModel)]="currentSender.postalCode"></div>
          <div class="col-md-1"><label for="senderCountry">Gouvernorat</label><input id="senderCountry" name="country" value="Tunisie" class="form-control form-control-sm bg-light" readonly [(ngModel)]="currentSender.country"></div>
          <div class="col-md-2"><label for="sendEmail">Email</label><input id="sendEmail" name="sendEmail" type="email" class="form-control form-control-sm" placeholder="Email" [(ngModel)]="currentSender.sendEmail"></div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0 mb-2 border-start border-warning border-4">
    <div class="card-header border-0 py-1 bg-warning d-flex align-items-center justify-content-between">
        <h6 class="mb-0 text-dark fw-bold" style="font-size: 0.8rem;">
            <i class="bi bi-person-down me-1 text-success"></i>DESTINATAIRE
        </h6>
        <button type="button" class="btn btn-xs btn-outline-dark border-0 py-0" (click)="currentReceiver = {country:'Tunisie'}" style="font-size: 0.7rem;">Effacer</button>
    </div>
    <div class="card-body py-2">
        <div class="row g-1">
            <div class="col-md-1">
                <label for="recCountry">Pays</label>
                <select id="recCountry" name="recCountry" class="form-select form-select-sm" (change)="coutryFilter()" [(ngModel)]="currentReceiver.country">
                    <option value="Tunisie" selected>Tunisie</option>
                        <option value="Algeria">Algérie</option>
                        <option value="Qatar">Qatar</option>
                        <option value="France">France</option>
                        <option value="Canada">Canada</option>
                        <option value="Ukraine">Ukraine</option>
                        <option value="Brazil">Brésil</option>
                        <option value="China">Chine</option>
                    </select>
            </div>

            <div class="col-md-2 position-relative">
                <label for="receiverTel">Téléphone</label>
                <input id="receiverTel" name="recTel" type="tel" class="form-control form-control-sm" placeholder="Téléphone"
                    [(ngModel)]="currentReceiver.recTel" (input)="checkReceiver($event)">
                
                <div class="suggestion-box shadow border" *ngIf="filteredReceivers.length > 0 && activeReceiverField === 'tel'">
                    <div class="suggestion-item p-2 border-bottom" *ngFor="let r of filteredReceivers" (click)="selectReceiver(r)">
                        <small><strong>{{ r.recTel }}</strong> - {{ r.recName }}</small>
                    </div>
                </div>
            </div>

            <div class="col-md-2 position-relative">
                <label for="receiverName">Nom et Prénom</label> 
                <input id="receiverName" name="recName" type="text" class="form-control form-control-sm" placeholder="Nom" required
                    [(ngModel)]="currentReceiver.recName" (input)="checkReceiver($event)">

                <div class="suggestion-box shadow border" *ngIf="filteredReceivers.length > 0 && activeReceiverField === 'name'">
                    <div class="suggestion-item p-2 border-bottom" *ngFor="let r of filteredReceivers" (click)="selectReceiver(r)">
                        <small><strong>{{ r.recName }}</strong> ({{ r.recTel }})</small>
                    </div>
                </div>
            </div>

            <div class="col-md-2 position-relative">
                <label for="recSocialraison">Raison Sociale</label>
                <input id="recSocialraison" name="recSocialReason" type="text" class="form-control form-control-sm" placeholder="Raison Sociale"
                    [(ngModel)]="currentReceiver.recSocialReason" (input)="checkReceiver($event)">

                <div class="suggestion-box shadow border" *ngIf="filteredReceivers.length > 0 && activeReceiverField === 'social'">
                    <div class="suggestion-item p-2 border-bottom" *ngFor="let r of filteredReceivers" (click)="selectReceiver(r)">
                        <small><strong>{{ r.recSocialReason }}</strong></small>
                    </div>
                </div>
            </div>

            <div class="col-md-3"><label for="receiverAdress">Adresse</label><input id="receiverAdress" name="recAdress" type="text" class="form-control form-control-sm" placeholder="Adresse" required [(ngModel)]="currentReceiver.adress"></div>
            <div class="col-md-2"><label for="receiverVille">Ville</label><input id="receiverVille" name="recVille" type="text" class="form-control form-control-sm" placeholder="Ville" required [(ngModel)]="currentReceiver.city"></div>
            <div class="col-md-2"><label for="receiverPostal">Code Postal</label><input id="receiverPostal" name="recPostalCode" type="text" class="form-control form-control-sm" placeholder="CP" [(ngModel)]="currentReceiver.postalCode"></div>
            <div class="col-md-2"><label for="receiverMail">Email</label><input id="receiverMail" name="recEmail" type="email" class="form-control form-control-sm" placeholder="Email" [(ngModel)]="currentReceiver.recEmail"></div>
        </div>
    </div>
</div>

    <div class="card border-0 shadow-sm bg-light mb-2">
      <div class="card-body py-2">
        <div class="row g-2 align-items-center">
          <div class="col-md-3">
            <div class="btn-group w-100 shadow-sm">
              <input type="radio" class="btn-check" [checked]="true" name="btnradio" *ngIf="isNat" (change)="onNatServiceChange()" id="btncheck1" value="EMS National">
              <label class="btn btn-outline-primary btn-sm fw-bold"  *ngIf="isNat" id="labelEmsNat" for="btncheck1">EMS NAT</label>
              <input type="radio" class="btn-check" name="btnradio" *ngIf="isRppi" [checked]="true" (change)="onOtherServiceChange($event)" id="btncheck3" value="RPPI">
              <label class="btn btn-outline-warning btn-sm fw-bold text-dark "  *ngIf="isRppi" id="labelRppi" for="btncheck3">RPPI</label>
              <input type="radio" class="btn-check" name="btnradio" id="btncheck2" (change)="onOtherServiceChange($event)" *ngIf="isEmsi" value="EMSI">
              <label class="btn btn-outline-info btn-sm fw-bold " id="labelEmsInt"  *ngIf="isEmsi" for="btncheck2">EMS INT</label>
              <input type="radio" class="btn-check" name="btnradio" id="btncheck4" (change)="onOtherServiceChange($event)" *ngIf="isFlour" value="FLEURS">
              <label class="btn btn-outline-success btn-sm fw-bold"  id="labelFleurs" *ngIf="isFlour" for="btncheck4">FLEURS</label>
            </div>
          </div>
          <div *ngIf="isNatParcel"  class="col-md-2" id="typeappelofre">
            <select id="itemTypeoffre" name="typeOffre" class="form-select form-select-sm border-primary">
              <option value="Normal">Normal</option>
              <option value="Appel">Appel d'offre</option>
            </select>
          </div>
          <div (change)="isMarchand($event)" *ngIf="isEmsi || isRppi" class="col-md-2" id="typeContainer">
            <select id="itemType" name="typeItem" class="form-select form-select-sm border-info">
              <option value="Document">Document</option>
              <option  value="Marchandise">Marchandise</option>
            </select>
          </div>
        

<div *ngIf="isMarchandise" id="dimensionsContainer" class="col-md-auto">
    <div class="d-flex align-items-end bg-light p-2 rounded border">
        <div class="me-3 d-flex align-items-center">
            <label for="quantity" class="form-label small fw-bold mb-0 me-2">Qté</label>
            <input id="quantity" name="quantity" type="number" 
                   class="form-control bg-info form-control-sm text-center" 
                   style="width: 60px;" value="1" min="1">
        </div>

        <div *ngIf="rppimarchand" class="ps-3 border-start border-2 d-flex align-items-center gap-1">
            <label class="form-label small fw-bold mb-0 text-muted me-1">Dim</label>
            <input id="longeur" name="length" type="number" class="form-control form-control-sm" placeholder="Long." style="width: 60px;">
            <input id="largeur" name="width" type="number" class="form-control form-control-sm" placeholder="Larg." style="width: 60px;">
            <input id="hauteur" name="height" type="number" class="form-control form-control-sm" placeholder="Haut." style="width: 60px;">
        </div>
    </div>
</div>

<div *ngIf="isMarchandise" id="btnFactureContainer" class="col-md-1">
    <button type="button" class="btn btn-outline-warning btn-sm w-70 fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#factureModal">
        <i class="bi bi-receipt"></i> FACTURE
    </button>
</div>
          <div class="col-md-1">
            <div class="input-group input-group-sm">
              <input type="number" [(ngModel)]="weight"
           (ngModelChange)="calculerPrix()" value="" min="0.001" step="any" name="weight" id="parcelWeight" class="form-control border-primary fw-bold" >
              <span class="input-group-text bg-primary text-white p-1">KG</span>
            </div>
          </div>
          
          <div class="col-md-2 d-flex align-items-center justify-content-end">
            <input type="hidden" id="parcelPrice" name="price" value="0">
            <span *ngIf="!overweignt" id="pricezone" class="fw-bold text-primary me-2">{{prix}}</span>
            <span *ngIf="overweignt"  class="  alert text-danger">Poids Max 30 KG</span>

            <button type="button" (click)="validerEnvoie()" id="btnValider" class="btn btn-success btn-sm px-3 fw-bold shadow-sm">VALIDER</button>
          </div>
        </div>
      </div>
    </div>
  </form>
  <div class="card border-0 shadow-sm bg-light mb-4" style="max-width: 600px;">
    <form #pochetteForm>
    <div class="card-body py-2">
        <div class="row g-2 align-items-center">
            <div class="col-md-3">
                <label for="pochette" class="form-label mb-0 fw-bold">Type de pochette</label>
            </div>
            
            <div class="col-md-9">
                <div class="d-flex gap-2 align-items-center">
                    <!-- Sélecteur de type -->
                    <select id="pochette" 
        name="typePochette"
        [(ngModel)]="pochette.typePochette" 
        class="form-select form-select-sm" 
        style="min-width: 180px;">
    <option value="" disabled selected>Choisir le type de pochette</option>
    <option value="pn">Pochette National</option>
    <option value="pnpm">Pochette International PM</option>
    <option value="pngm">Pochette International GM</option>
    <option value="mat">Pochette matelassé</option>
</select>

<input id="quantitePochette" 
       name="quantitePochette"
       [(ngModel)]="pochette.totalPrice" 
       type="number" 
       class="form-control form-control-sm" 
       style="width: 70px;" [(ngModel)]="pochette.quantite" min="1"/>
                    
                    <!-- Bouton Ajouter -->
                    <button title="Ajouter" (click)="addPochette($event)" type="button" class="btn btn-primary  ms-2">
Ajouter                    </button>
                </div>
            </div>
        </div>
    </div>
    </form>
</div>
<div class="modal fade" id="factureModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white p-2">
                <h6 class="modal-title">Saisie de la Facture</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea id="factureDetail" class="form-control mb-2" rows="3" placeholder="Description des articles..."></textarea>
                <input type="number" id="factureVal" class="form-control" placeholder="Valeur estimée (DT)">
            </div>
            <div class="modal-footer p-1">
                <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
<div class="table-responsive">
                     <div class="card-header bg-light text-dark d-flex justify-content-between align-items-center py-3">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-collection me-2 text-warning"></i>Mode de payment</h5>
                        <select (change)="modeDePayment($event)" id="sessionFilter" class="form-select form-select-sm w-auto" >
                            
                            <option value="espece">Espèce</option>
                            <option value="cheque">Chèque</option>
                        </select>
                        <span *ngIf="cheque">
                            <label >Banque</label>
                            <input>
                            <label >N° de chèque</label>
                            <input>
                        </span>
                        <button type="button" class="btn btn-outline-warning btn-lg px-5 shadow" >
                            <i class="bi bi-printer-fill me-2"></i>Confirmer
                        </button>
                        <span class="badge bg-primary px-4" id="colisCount">Colis :{{ parcels ? parcels.length : 0 }}</span>
                        <span class="badge bg-info px-4 " id="pochetteCount">Pochettes :{{ pochettes ? pochettes.length : 0 }} </span>

                    </div>
  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>Quantité</th>
        <th>Destinataire</th>
        <th>Raison Sociale</th>
        <th>Poids (kg)</th>
        <th>Prix (TND)</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let p of parcels">
        <td>1</td> <td>{{ p.receiver?.recName || 'N/A' }}</td>
        <td>{{ p.receiver.recSocialReason || 'Particulier' }}</td>
        <td>{{ p.weight }}</td>
        <td>{{ p.price | number:'1.3-3' }}</td>
      </tr>
    </tbody>
    <tbody>
      <tr *ngFor="let p of pochettes">
      
        <td>{{p.quantite}}</td> 
        <td>{{ p.sender?.sendName || 'N/A' }}</td>
        <td>{{ p.sender.sendSocialReason || 'Particulier' }}</td>
        <td>--</td>
        <td>{{ p.totalPrice | number:'1.3-3' }}</td>
      </tr>
    </tbody>
    <tfoot class="table-light font-weight-bold">
      <tr>
        <td colspan="4" class="text-end"><strong>Total :</strong></td>
        <td><strong>{{ calculateTotal() | number:'1.3-3' }} TND</strong></td>
      </tr>
    </tfoot>
  </table>
</div>
  </div>